---
- name: "Cron | Brew update every day at 12 noon"
  cron:
    name: "Brew Update"
    minute: "0"
    hour: "12"
    job: "brew update"
  tags:
    - cron
    - brew
    - brew_update

- name: "Cron | Brew cleanup every 1st of the month at 12:30 noon"
  cron:
    name: "Brew Cleanup"
    minute: "30"
    hour: "12"
    day: "1"
    job: "brew cleanup --prune=all"
  tags:
    - cron
    - brew
    - brew_cleanup

- name: "Cron | Ensure VirtualEnv is installed"
  homebrew:
    name: virtualenv
    state: present
  tags:
    - cron
    
- name: "Scripts | Ensure ~/.scripts folder exists"
  file:
    path: ~/.scripts
    state: directory

- name: "Cron | Setup NH Organizer"
  vars:
    current_install_dir: "~/.scripts/nh-organizer"
    repository: "{{ nho.repository }}"
  block:
    - name: "NHO | Clone from repository"
      git:
        repo: "{{ repository }}"
        dest: "{{ current_install_dir }}"
        update: yes
        force: yes
    - name: "NHO | Install via Poetry"
      shell: "poetry install"
      args:
        chdir: "{{ current_install_dir }}"
    - name: "NHO | Write .env file"
      copy:
        dest: "{{ current_install_dir }}/.env"
        content: "{{ nho.env }}"
    - name: "NHO | Export requirements.txt"
      shell: "poetry export --without-hashes --format=requirements.txt > requirements.txt"
      args:
        chdir: "{{ current_install_dir }}"
    - name: "NHO | Install requirements"
      pip:
        requirements: "{{ current_install_dir }}/requirements.txt"
        virtualenv: "{{ current_install_dir }}"
    - name: "NHO | Run every hour"
      cron:
        name: "NHO"
        minute: "0"
        hour: "*"
        job: "{{ current_install_dir }}/bin/python3 {{ current_install_dir }}/main.py"
  tags:
    - cron

- name: "Cron | H3D"
  vars:
    current_install_dir: "~/.scripts/h3d-organizer"
    repository: "{{ h3d.repository }}"
  block:
    - name: "H3D | Clone from repository"
      git:
        repo: "{{ repository }}"
        dest: "{{ current_install_dir }}"
        update: yes
        force: yes
    - name: "H3D | Install via Poetry"
      shell: "poetry install"
      args:
        chdir: "{{ current_install_dir }}"
    - name: "H3D | Write .env file"
      copy:
        dest: "{{ current_install_dir }}/.env"
        content: "{{ h3d.env }}"
    - name: "H3D | Export requirements.txt"
      shell: "poetry export --without-hashes --format=requirements.txt > requirements.txt"
      args:
        chdir: "{{ current_install_dir }}"
    - name: "H3D | Install requirements"
      pip:
        requirements: "{{ current_install_dir }}/requirements.txt"
        virtualenv: "{{ current_install_dir }}"
    - name: "H3D | Run every hour 15 minutes"
      cron:
        name: "H3D"
        minute: "15"
        hour: "*"
        job: "{{ current_install_dir }}/bin/python3 {{ current_install_dir }}/main.py"
  tags:
    - cron
